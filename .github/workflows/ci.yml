name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        java: ['25']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: Build (compile)
        run: mvn -B -DskipTests compile

      - name: Sampler smoke tests
        run: >
          mvn -B -pl DynamisFX-Samples test
          -Dtest=org.dynamisfx.samples.utilities.ServiceDiscoverySmokeTest,org.dynamisfx.samples.utilities.RigidBodyBackendSelectorTest

      - name: Jolt forced-fallback smoke
        run: >
          mvn -B -pl DynamisFX-Samples test
          -Dtest=RigidBodyBackendSelectorTest#joltForcedFailureFallsBackToOde4j
          -Ddynamisfx.samples.physics.forceJoltFailure=true

      - name: SLF4J dependency sanity
        run: |
          mvn -B -pl DynamisFX-Samples -DskipTests dependency:tree -Dincludes=org.slf4j:slf4j-simple -Dverbose > slf4j-tree.txt
          if grep -E "slf4j-simple:jar:1\.[0-9]+\.[0-9]+:compile$" slf4j-tree.txt; then
            echo "Legacy slf4j-simple 1.x binding is active in compile scope"
            cat slf4j-tree.txt
            exit 1
          fi
